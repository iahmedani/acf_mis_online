<% layout('boilerplate') %>
<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>
<style>
  .my_box {
    border: 0.5px solid grey;
    padding: 10px 10px !important;
  }
  .my_box > input {
    margin: 0%  !important;
    border-bottom: none !important;
  }
  .input-field {
    margin-top: 0% !important;
    margin-bottom: 0% !important;
  }
  .col .row {
    margin-left: 0% !important;
    margin-right: 0% !important;
    margin-bottom: 0% !important;
  }
  th{
    font-size: 0.75rem;
  }
  td, td{
    font-size: 0.75rem;
    padding: 0%;
    text-align: center !important;
  }
  input {
    border: 0px;
    height: 100%;
  }
  tr, th, td {
    border: 0.5px solid grey;
  }
  </style>
<main>
  <div class="card" id="dnnReport">
    <div class="row">
      <div class="col s12">
        <h5 class="center-align">DELIVERY NOTE </h5>
      </div>
    </div>
    <form action="/warehouse/common/checks" method="POST" id="dnForm" class="col s12">
    <div class="row">
      <div class="col s12 m4 l4 input-field"><input type="text" name="delNote_ref_num" id="delNote_ref_num"><label for="delNote_ref_num">DN
          Reference</label></div>
      <div class="col s12 m4 l4 input-field"><input type="text" name="sro_ref_num" id="sro_ref_num"><label for="sro_ref_num">SRO
          Reference</label></div>
      <div class="col s12 m4 l4 input-field"><input type="date" name="del_date" id="del_date"><label for="del_date">Date</label></div>
    </div>
    <div class="row">
      <div class="col s6 my_box">
        <div class="row input-field">
          <input type="text" name="shipper_name" id="shipper_name">
          <label for="shipper_name">Name</label>
        </div>
        <div class="row input-field">
          <input type="text" name="shipper_address" id="shipper_address">
          <label for="shipper_address">Address</label>
        </div>
        <div class="row input-field"><input type="text" name="shipper_phone" id="shipper_phone">
          <label for="shipper_phone">Phone</label></div>
        <div class="row input-field"><input type="text" name="shipper_sig" id="shipper_sig">
          <label for="shipper_sig">Signature</label></div>
      </div>
      <div class="col s6 my_box">
        <div class="row input-field">
          <input type="text" name="consg_name" id="consg_name">
          <label for="consg_name">Name</label>
        </div>
        <div class="row input-field"><input type="text" name="consg_position" id="consg_position">
          <label for="consg_position">Position</label></div>
        <div class="row input-field">
          <input type="text" name="consg_address" id="consg_address">
          <label for="consg_address">Address</label>
        </div>
        <div class="row input-field"><input type="text" name="consg_phone" id="consg_phone">
          <label for="consg_phone">Phone</label></div>

      </div>
    </div>
    <div class="row">
      <div class="col s6 image-responsive">
        <img src="/img/acf_dnn.png" class="card-image" alt="">
      </div>
      <div class="col s6 my_box">
        <div class="row input-field">
          <input type="text" name="trans_name" id="trans_name">
          <label for="trans_name">Name</label>
        </div>

        <div class="row input-field">
          <input type="text" name="trans_address" id="trans_address">
          <label for="trans_address">Address</label>
        </div>
        <div class="row input-field"><input type="text" name="trans_phone" id="trans_phone">
          <label for="trans_phone">Phone</label></div>
        <div class="row input-field"><input type="text" name="trans_reg_num" id="trans_reg_num">
          <label for="trans_reg_num">Registration #</label></div>
        <div class="row input-field"><input type="date" name="trans_date" id="trans_date">
          <label for="trans_date">Date</label></div>
      </div>
    </div>
    
    <div class="row">
      <table class="table" id="tb">

      <!-- <div class="col s12 m12 l12" id="dnGrid"></div> -->
        <tr>
          <th>Country Code</th>
          <th>Base Code</th>
          <th>Dept: Code</th>
          <th>Proc: Request #</th>
          <th>Proc: Request Line Item</th>
          <th>Item Name</th>
          <th>Batch ID</th>
          <th>Qty Out</th>
          <th>Unit</th>
          <th>Received Quantity</th>
          <th>Quality, observations</th>
          <th>Action</th>
        </tr>
      </table>
        
    </div>
    <div class="row">

      <div class="input-field col s12">
        <textarea id="textarea1" class="materialize-textarea" name="remarks"></textarea>
        <label for="textarea1">Remarks</label>
      </div>
      </div>
      <div class="row">
        <input type="submit" value="submit" class="btn">
      </div>
      </form>
      <div class="row">
        <div class="col s12" id="stockGrid"></div>
      </div>

      
  </div>
</main>
<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="/js/jspdf.min.js"></script>
<script>
  $(function () {
    $.fn.serializeFormJSON = function () {

      var o = {};
      var a = this.serializeArray();
      $.each(a, function () {
        if (o[this.name]) {
          if (!o[this.name].push) {
            o[this.name] = [o[this.name]];
          }
          o[this.name].push(this.value || '');
        } else {
          o[this.name] = this.value || '';
        }
      });
      return o;
    };
    $('#addMore').on('click', function () {
      var data = $("#tb tr:eq(1)").clone(true).appendTo("#tb");
      data.find("input").val('');
    });
    $(document).on('click', '.remove', function () {
      var trIndex = $(this).closest("tr").index();
      $(this).closest("tr").remove();
      // if (trIndex > 1) {
      // } else {
      //   alert("Sorry!! Can't remove first row!");
      // }
    });
  });
  $(function(){
    var code=0;
    $('#stockGrid').jsGrid({
       height: "400px",
      width: "98%",
      filtering: false,
      editing: false,
      sorting: true,
      paging: false,
      autoload: true,
      selecting: true,
      // pageSize: 15,
      // pageButtonCount: 5,
      deleteConfirm: "Do you really want to delete the client?",
      controller: {        
        loadData: function (filter) { 
          return $.ajax({
            url:'/warehouse/common/stocks',
            method:'POST',
            data:filter
          })
         },
      },
      fields:[
        {name:'country_code',title:'Country Code', type:'text'},
        {name:'base_code',title:'Base Code', type:'text'},
        {name:'dept_code',title:'Req Dept Code', type:'text'},
        {name:'proc_req',title:'Proc Req #', type:'text'},
        {name:'proc_line',title:'Proc Line', type:'text'},
        {name:'proj_code',title:'Project Code', type:'text'},
        {name:'cat',title:'Category', type:'text'},
        {name:'item_desc',title:'Description', type:'text'},
        { name: 'stockIn_id', title: 'Base Code', type: 'text' },
        {name:'rem_stock',title:'Stock Available', type:'number', filtering:false}
      ],
      rowClick: function(args){
        var getData = args.item;
        console.log(getData)

        var html = `<tr>
          <td><input type="text" name="country_code" id="country_code_${code}" class="browser-default" value="${getData.country_code}" readonly></td>
          <td><input type="text" name="base_code" id="base_code_${code}" class="browser-default" value="${getData.base_code}" readonly></td>
          <td><input type="text" name="dept_code" id="dept_code_${code}" class="browser-default" value="${getData.dept_code}" readonly></select></td>
          <td><input type="text" name="pr_num" id="pr_num_${code}" class="browser-default" value="${getData.proc_req}" readonly></td>
          <td><input type="text" name="pr_line" id="pr_line_${code}" class="browser-default"  value="${getData.proc_line}" readonly></td>
          <td><input type="text" name="item_name" id="item_name_${code}" class="browser-default" value="${getData.proc_line}" readonly></td>
          <td><input type="number" name="item_batch" id="item_batch_${code}" class="browser-default" value="${getData.stockIn_id}" readonly ></td>
          <td><input type="number" name="out_qty" id="out_qty_${code}" class="browser-default" required min="0"> </td>
          <td><input type="number" id="rem_stock_${code}" class="browser-default" hidden min="0"> </td>
          <td><input type="text" name="out_unit" id="out_unit_${code}" class="browser-default" required min="0"></td>
          <td><input type="number" name="qty_delivered" id="qty_delivered_${code}" class="browser-default" readonly></td>
          <td><input type="text" name="obs_delivered" id="obs_delivered_${code}" class="browser-default" readonly></td>
          <td><a href="javascript:void(0);" class="remove">Remove</a></td>
        </tr>`
        console.log(args)
        var table, inputs, arr;

        table = document.getElementById('tb');
        inputs = table.querySelectorAll('input[name="item_batch"]');
        arr = [].slice.call(inputs).map(function (node) { return node.value; });
       console.log(arr);
       function valOne( arr){
         var myCheck = false;
         arr.forEach(el=>{
           if(el == getData.stockIn_id){
             console.log(true)
             myCheck = true
           }
         })
         return myCheck;
       }
       if(!valOne(arr)){
          $("#tb").append(html);
         code++;
        
       } else {
         alert('Multiple entry of same item is not allowed')
       }
        
        // data.find("input").val('');
      }
    })
  })

  // function ($) {
  //     $.fn.serializeFormJSON = function () {

  //       var o = {};
  //       var a = this.serializeArray();
  //       $.each(a, function () {
  //         if (o[this.name]) {
  //           if (!o[this.name].push) {
  //             o[this.name] = [o[this.name]];
  //           }
  //           o[this.name].push(this.value || '');
  //         } else {
  //           o[this.name] = this.value || '';
  //         }
  //       });
  //       return o;
  //     };
    // })(jQuery);
  // $('#dnForm').on('submit', function(e){
  //   e.preventDefault();
  //   var formData = $(this).serialize();
  //   console.log(formData)
  // })
  $('#dnForm').on('submit', function(e){
    
      e.preventDefault();
      var formData = $(this).serialize();

      $.ajax({
        url:'/warehouse/common/checks',
        method:'POST',
        data:formData,
        success:(data)=>{
          console.log(data);
        }
      })
      console.log(formData)
    
  })



</script>